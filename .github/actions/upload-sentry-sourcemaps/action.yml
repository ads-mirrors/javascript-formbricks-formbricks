name: 'Upload Sentry Sourcemaps'
description: 'Extract sourcemaps from Docker image and upload to Sentry'

inputs:
  docker_image:
    description: 'Docker image to extract sourcemaps from'
    required: true
  release_version:
    description: 'Sentry release version (e.g., v1.2.3)'
    required: true
  sentry_auth_token:
    description: 'Sentry authentication token'
    required: true
  environment:
    description: 'Sentry environment (e.g., production, staging)'
    required: false
    default: 'staging'

runs:
  using: 'composite'
  steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Validate Sentry auth token
      shell: bash
      run: |
        set -euo pipefail
        echo "üîê Validating Sentry authentication token..."

        # Assign token to local variable for secure handling
        SENTRY_TOKEN="${{ inputs.sentry_auth_token }}"

        # Test the token by making a simple API call to Sentry
        response=$(curl -s -w "%{http_code}" -o /tmp/sentry_response.json \
          -H "Authorization: Bearer $SENTRY_TOKEN" \
          "https://sentry.io/api/0/organizations/formbricks/")

        http_code=$(echo "$response" | tail -n1)

        if [ "$http_code" != "200" ]; then
          echo "‚ùå Error: Invalid Sentry auth token (HTTP $http_code)"
          echo "Please check your SENTRY_AUTH_TOKEN is correct and has the necessary permissions."
          if [ -f /tmp/sentry_response.json ]; then
            echo "Response body:"
            cat /tmp/sentry_response.json
          fi
          exit 1
        fi

        echo "‚úÖ Sentry auth token validated successfully"

        # Clean up temp file
        rm -f /tmp/sentry_response.json

    - name: Extract sourcemaps from Docker image
      shell: bash
      run: |
        set -euo pipefail
        echo "üì¶ Extracting sourcemaps from Docker image: ${{ inputs.docker_image }}"

        # Create temporary container from the image and capture its ID
        echo "Creating temporary container..."
        CONTAINER_ID=$(docker create "${{ inputs.docker_image }}")
        echo "Container created with ID: $CONTAINER_ID"

        # Set up cleanup function to ensure container is removed on script exit
        cleanup_container() {
          # Capture the current exit code to preserve it
          local original_exit_code=$?
          
          echo "üßπ Cleaning up Docker container..."
          
          # Remove the container if it exists (ignore errors if already removed)
          if [ -n "$CONTAINER_ID" ]; then
            docker rm -f "$CONTAINER_ID" 2>/dev/null || true
            echo "Container $CONTAINER_ID removed"
          fi
          
          # Exit with the original exit code to preserve script success/failure status
          exit $original_exit_code
        }
        
        # Register cleanup function to run on script exit (success or failure)
        trap cleanup_container EXIT

        # Extract .next directory containing sourcemaps
        docker cp "$CONTAINER_ID:/home/nextjs/apps/web/.next" ./extracted-next

        # Verify .next directory structure exists
        if [ ! -d "./extracted-next" ]; then
          echo "‚ùå Error: .next directory not found in Docker image"
          echo "Expected structure: /home/nextjs/apps/web/.next/"
          exit 1
        fi

        echo "üîç Scanning for sourcemaps in entire .next directory..."

        # Count sourcemaps in all locations within .next directory
        total_sourcemap_count=$(find ./extracted-next -name "*.map" 2>/dev/null | wc -l || echo "0")
        static_sourcemap_count=$(find ./extracted-next/static -name "*.map" 2>/dev/null | wc -l || echo "0")
        server_sourcemap_count=$(find ./extracted-next/server -name "*.map" 2>/dev/null | wc -l || echo "0")

        echo "‚úÖ Found $total_sourcemap_count total sourcemap files in .next directory"
        echo "  ‚îî‚îÄ‚îÄ $static_sourcemap_count in /static directory"
        echo "  ‚îî‚îÄ‚îÄ $server_sourcemap_count in /server directory"

        # Show breakdown by subdirectory for debugging
        echo ""
        echo "üìÇ Sourcemap distribution by directory:"
        find ./extracted-next -name "*.map" 2>/dev/null | sed 's|./extracted-next/||' | cut -d'/' -f1 | sort | uniq -c | sort -nr

        if [ "$total_sourcemap_count" -eq 0 ]; then
          echo "‚ùå Error: No sourcemap files found in .next directory."
          echo "Check that productionBrowserSourceMaps is enabled and Sentry plugin is configured correctly."
          exit 1
        fi

        echo ""
        echo "üéØ Expected ~553 sourcemap files based on build output. Found: $total_sourcemap_count"

    - name: Debug sourcemaps structure before upload
      shell: bash
      run: |
        echo "üîç Debugging sourcemap structure for getsentry/action-release@v3..."
        echo "Directory structure:"
        ls -la ./extracted-next/ || true
        echo ""
        echo "Sample sourcemap files:"
        find ./extracted-next -name "*.map" | head -20
        echo ""
        echo "Checking file sizes:"
        find ./extracted-next -name "*.map" -exec ls -lh {} \; | head -10

    - name: Create Sentry release and upload sourcemaps
      uses: getsentry/action-release@v3
      env:
        SENTRY_AUTH_TOKEN: ${{ inputs.sentry_auth_token }}
        SENTRY_ORG: formbricks
        SENTRY_PROJECT: formbricks-cloud
      with:
        environment: ${{ inputs.environment }}
        release: ${{ inputs.release_version }}
        sourcemaps: './extracted-next/'
        url_prefix: '~/_next/'
        set_commits: auto

    - name: Clean up extracted files
      shell: bash
      if: always()
      run: |
        set -euo pipefail
        # Clean up extracted files
        rm -rf ./extracted-next
        echo "üßπ Cleaned up extracted files"
