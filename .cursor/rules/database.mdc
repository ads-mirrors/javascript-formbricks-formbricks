---
description: >
  This rule provides comprehensive knowledge about the Formbricks database structure, relationships, 
  and data patterns. It should be used **only when the agent explicitly requests database schema-level 
  details** to support tasks such as:
  
  - Writing or debugging Prisma queries
  - Designing or reviewing new features or data models
  - Investigating data relationships or multi-tenancy behavior
  - Creating API endpoints or integrations that involve surveys, responses, or contacts
  - Understanding soft-deletion, cascading behaviors, or constraints

  It must NOT be applied automatically in all contexts to avoid unnecessary data injection or complexity.

globs: []
alwaysApply: agent-requested
---
# Formbricks Database Schema Reference

This rule provides a reference to the Formbricks database structure. For the most up-to-date and complete schema definitions, please refer to the schema.prisma file directly.

## Database Overview

Formbricks uses PostgreSQL with Prisma ORM. The schema is designed for multi-tenancy with strong data isolation between organizations.

### Core Hierarchy
```
Organization
└── Project
    └── Environment (production/development)
        ├── Survey
        ├── Contact
        ├── ActionClass
        └── Integration
```

## Schema Reference

For the complete and up-to-date database schema, please refer to:
- Main schema: `packages/database/schema.prisma`

The schema.prisma file contains all model definitions, relationships, enums, and field types. This ensures you always have access to the most current schema information.

## Common Data Patterns

### JSON Field Structures

#### Survey Questions
```typescript
type SurveyQuestion = {
  id: string;
  type: 'openText' | 'multipleChoiceSingle' | 'multipleChoiceMulti' | 'nps' | 'cta' | 'rating' | 'consent' | 'pictureSelection' | 'cal' | 'fileUpload' | 'matrix' | 'address';
  headline: string;
  subheader?: string;
  required?: boolean;
  // Type-specific properties...
}[];
```

#### Response Data
```typescript
type ResponseData = {
  [questionId: string]: string | string[] | number;
};
```

#### Contact Attributes
```typescript
type ResponseContactAttributes = {
  [attributeKey: string]: string;
};
```


## Data Access Patterns

### Multi-tenancy
- All data is scoped by Organization
- Environment-level isolation for surveys and contacts
- Project-level grouping for related surveys

### Soft Deletion
Some models use soft deletion patterns:
- Check `isActive` fields where present
- Use proper filtering in queries

### Cascading Deletes
Configured cascade relationships:
- Organization deletion cascades to all child entities
- Survey deletion removes responses, displays, triggers
- Contact deletion removes attributes and responses

## Common Query Patterns

### Survey with Responses
```typescript
// Include response count and latest responses
const survey = await prisma.survey.findUnique({
  where: { id: surveyId },
  include: {
    responses: {
      take: 10,
      orderBy: { createdAt: 'desc' }
    },
    _count: {
      select: { responses: true }
    }
  }
});
```

### Environment Scoping
```typescript
// Always scope by environment
const surveys = await prisma.survey.findMany({
  where: {
    environmentId: environmentId,
    // Additional filters...
  }
});
```

### Contact with Attributes
```typescript
const contact = await prisma.contact.findUnique({
  where: { id: contactId },
  include: {
    attributes: {
      include: {
        attributeKey: true
      }
    }
  }
});
```

